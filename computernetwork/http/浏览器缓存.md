# 浏览器缓存

浏览器缓存的三个部分：

- 强缓存
- 协商缓存
- 缓存位置

## 强缓存

在HTTP/1.0和HTTP/1.1当中，字段不同。

### Expires

HTTP/1.0中使用的是Expires，存储的是时间，但是服务器的时间和客户端的时间可能不一样，所以被废弃了。

### Cache-Control

HTTP/1.1中使用的Cache-Control ，使用max-age来控制时间，其中Cache-control还有别的字段。

- no-cache不使用强缓存，直接使用协商缓存 
- no-store 不进行任何形式的缓存

## 协商缓存

使用缓存tag来向服务器发送请求，由服务器决定是否使用缓存。

- Last-Modified
- ETag 

### Last-Modified

即最后修改时间，浏览器第一次请求的时候，服务器会在响应头上加上这个字段，浏览器接收后，如果再次请求，就会在请求头中携带If-Modified-Since字段， 值为上次请求传来的Last-Modified的值，然后服务器会拿这个和该资源的最后修改时间对比，如果时间小于最后修改时间，则返回新的资源，否则返回304，告诉浏览器直接用缓存。

### ETag

ETag是服务器根据当前文件的内容，给文件生成的唯一标识，只要里面的内容有改动，这个值就会变。服务器通过响应头把这个值给浏览器。

然后浏览器在下次请求会放到If-None-Match这个字段中，发送给服务器，服务器接收到后会和该资源的ETag进行比较，如果不一样，则更新，否则返回304。

### 两者对比

1. 在精准度上，ETag优于Last-Modified。优于 ETag 是按照内容给资源上标识，因此能准确感知资源的变化。而 Last-Modified 就不一样了，它在一些特殊的情况并不能准确感知资源变化，主要有两种情况:

- 编辑了资源文件，但是文件内容并没有更改，这样也会造成缓存失效。
- Last-Modified 能够感知的单位时间是秒，如果文件在 1 秒内改变了多次，那么这时候的 Last-Modified 并没有体现出修改了。

1. 在性能上，Last-Modified优于ETag，也很简单理解，Last-Modified仅仅只是记录一个时间点，而 Etag需要根据文件的具体内容生成哈希值。

另外，如果两种方式都支持的话，服务器会优先考虑ETag。

##  缓存位置

前面我们已经提到，当强缓存命中或者协商缓存中服务器返回304的时候，我们直接从缓存中获取资源。那这些资源究竟缓存在什么位置呢？

浏览器中的缓存位置一共有四种，按优先级从高到低排列分别是：

- Service Worker
- Memory Cache
- Disk Cache
- Push Cache

### Service Worker

Service Worker 借鉴了 Web Worker的 思路，即让 JS 运行在主线程之外，由于它脱离了浏览器的窗体，因此无法直接访问DOM。虽然如此，但它仍然能帮助我们完成很多有用的功能，比如离线缓存、消息推送和网络代理等功能。其中的离线缓存就是 **Service Worker Cache**。

Service Worker 同时也是 PWA 的重要实现机制，关于它的细节和特性，我们将会在后面的 PWA 的分享中详细介绍。

### Memory Cache 和 Disk Cache

**Memory Cache**指的是内存缓存，从效率上讲它是最快的。但是从存活时间来讲又是最短的，当渲染进程结束后，内存缓存也就不存在了。

**Disk Cache**就是存储在磁盘中的缓存，从存取效率上讲是比内存缓存慢的，但是他的优势在于存储容量和存储时长。稍微有些计算机基础的应该很好理解，就不展开了。

好，现在问题来了，既然两者各有优劣，那浏览器如何决定将资源放进内存还是硬盘呢？主要策略如下：

- 比较大的JS、CSS文件会直接被丢进磁盘，反之丢进内存
- 内存使用率比较高的时候，文件优先进入磁盘

## 总结

浏览器缓存分为强缓存和协商缓存，强缓存一般用Cache-Control来控制，当强缓存失效，即缓存过期或者我们设置了no-cache，那么就会直接进入 协商缓存阶段，协商缓存主要是2种方法，

- 一种是服务器会给客户端传 Last-Modified 字段，这是一个时间，当客户端请求的时候会作为If-Modifiled-Since的值来传给服务器，然后比较时间。 
- 另一种是根据资源生成ETag，然后客户端请求的时候会作为If-None-Match的值来传给服务端，跟文件进行比较。

当强缓存命中或者协商缓存返回304的时候，就会去取缓存中的资源了，优先级从高到底为

- Service Worker
- Memory Cache
- Disk Cache
- Push Cache