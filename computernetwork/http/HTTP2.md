# HTTP/2

主要优化是两点：

- 头部压缩
- 多路复用

还有颠覆性功能：

- 设置请求优先级
- 服务器推送

## 头部压缩

会对请求头进行压缩，采用HPACK算法

主要亮点为：

- 会在客户端和服务器之间建立哈希表，把字段放在这张表中，在传输的时候如果传输过值，则传一个索引
- 对整数和字符串进行赫夫曼编码，让多次出现的字符对应的索引尽可能短。 

## 多路复用

HTTP在上一个请求没有处理完的时候，后一个请求会被阻塞住，所以HTTP/2引入了多路复用的概念。

我们使用二进制分帧来完成多路复用，我们传输的不再是明文，而是一个个的二进制帧，这些二进制帧不存在先后关系，因此也就不会排队等待了，也就没有了HTTP的队头阻塞问题。

通信双方都可以给对方发送二进制帧，这种二进制帧的双向传输序列，也叫做流。HTTP/2用流在一个TCP连接上进行多个数据帧的通信。

不同ID的Stream是乱序的，但是同一个ID的帧是按顺序传输的，二进制帧到达对方后悔将Stream ID相同的二进制帧组装成完成的请求报文和响应报文。

## 服务器推送

服务器可以主动向客户端发送消息，比如当浏览器请求一个HTML文件的时候，可以将HTML中引用的其他资源一起返回给客户端，减少客户端的等待时间。

## 二进制帧是如何设计的？

每个帧非为帧头和帧体。

1. 3个字节的帧长度，表示帧体的长度
2. 1个字节的帧类型，分为数据帧和控制帧，数据帧用来存在HTTP报文，控制帧用来管理流的传输
3. 帧标志，里面一共有 8 个标志位，常用的有**END_HEADERS**表示头数据结束，**END_STREAM**表示单方向数据发送结束。
4. 后4个字节是Stream ID，接收方可以从乱序的二进制帧中选择出ID相同的帧，按顺序组装成请求/响应报文。 

## 流的特性

- 并发性，可以在一个连接上同时发送多个帧
- 自增性，流ID会自增，到达上限后新开TCP连接从头开始
- 双向性，客户端和服务端可以互不干扰地向对方发送流
- 可以设置优先级，让服务端优先处理重要资源

总结：

HTTP2对性能提升主要是2点，

第一点头部压缩，采用HPACK，其中用到使用哈希表存储传输过的值的索引和对数字字符串进行赫夫曼编码

第二点是多路复用，采用传输二进制帧的方式，来进行一个TCP连接上的多个数据帧的通信，所以就没有了队头阻塞的问题。

还有新增功能，比如服务器推送即服务器可以主动发送消息给客户端，或者是设置请求优先级，