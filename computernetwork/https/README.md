## https学习笔记

### 关于http
http是前端开发最常见的一个协议，我们已经使用这个协议有好一段时间了，但是这个协议的缺点其实也是很明显的。
 - 通信使用不加密的明文，很容易被窃听。
 - 不验证通信方的身份，因此很有可能遭遇伪装
 - 无法验证接收方报文的完整性，很可能接受到的是已经被篡改过的内容了

### 怎么办？
我们首先想到肯定就是加密，加密有两种方式，
1. 是把通信的线路加密，但是http中没有加密的方式，所以我们通过和SSL（Secure Socket Layer，安全套接层）或者TLS（Transport Layer Secure，安全传输层协议）组合使用，来进行通道的加密。通过使用SSL建立的安全通道以后，我们就可以在这条线路上进行通信了，而这个就是我们通常所说的https了。
2. 是内容加密，内容加密是使用sha1或者md5来对内容进行加密，但是这种方法还是很容易被拿到通信内容，而且无法完全保证md5或者sha1的代码没有被篡改，所以这种方法是行不通的。

### http + 加密 + 认证 + 完整性保护 = https

https就是添加了加密机制以后的http协议。而这个加密机制就是SSL，https不是在应用层的新协议，而是在http的接口部分用SSL来代替，本来http是和tcp直接通信的，但是https在披上了SSL的外衣以后，http就先和SSL通信，然后再由SSL转发给tcp来实现交互。

#### 加密方式
通常会有两种加密方式，
1. 第一种叫做公开密钥加密，也成为对称密钥加密，顾名思义，就是加密和解密用的是同一个密钥，但是这样问题又来了，在我们通信的时候，我们是需要把密钥发送给客户端的，那么在发送的时候密钥也很有可能会被截获，这样就失去了加密的意义了。
2.第二种就成为公开密钥加密，这也是SSL使用的加密方式，这种方式也被成为非对称密钥加密，这种加密方式拥有两种密钥，一种叫做公开密钥，一种叫做私有密钥。我们在通信的时候，可以将公开密钥发送给任何人，但是我们保留私有密钥，发送方在发送前使用公钥加密，接收方在接受到以后，使用私钥解密。并且以当前的技术，想要用公钥和加密内容进行解密是几乎是不可能做到的。

#### https使用两者混合的加密方式进行加密

不难看出来，公开密钥加密的速度一定会比共享密钥加密的方式要慢很多，所以我们就取二者的优点来结合使用。在密钥交换的环节，我们使用共享密钥的加密方式，而在正式交换内容的环节我们使用公开密钥的加密方式，这样就结合了二者的优点。

#### 公开加密方式的问题

公开密钥也会有一定的问题，在接收到公开密钥以后，我们很难直到我们收到的公钥是不是我们真正的请求方所发送的公钥，如果在发送过程中我们的公钥被攻击者篡改为他们自己的公钥，而在返回时候，他们再截获内容而使用他们的自己的私钥进行解密，那么这样就会泄露我们的内容了。所以这里我们使用公开密钥验证的证书。证书一般有数字证书认证机构颁发。接下来我们来看看证书认证的流程。

#### 证书认证的流程

1. 首先服务器向数字证书认证机构提出公开密钥的申请，数字证书认证机构在判明申请者的身份之后，会对已申请的公开密钥做数字签名，然后分配这个已申请的公开密钥，然后将公开密钥放入公钥证书后绑定在一起。
2. 然后服务器会把这个公钥证书发给客户端，客户端做为公钥来进行公开密钥加密方式的通信。
3. 客户端在接收到公开密钥后，对密钥证书上的数字签名进行验证，一旦验证通过，就可以确定两件事，认证服务器的公开密钥是真实可信的数字认证机构和服务器的公开密钥是值得信赖的。
4. 然后客户端在加密后，向服务器发起请求，服务器就可以使用私钥进行解密。

公开密钥是一定要安全的转交给客户端的，但是怎么转发都可能会有问题，所以浏览器厂商很多时候就直接把常用认证机关的公钥植入浏览器。

#### https通信流程
接下来就是我们最最关注的https的通信流程了。
1. 客户端通过发送Client Hello报文开始SSL通信。报文中包含客户端支持的SSL指定版本、加密组件列表（所使用的加密算法以及密钥长度等）。
2. 服务器可进行SSL通信是，会以Server Hello报文作为应答。报文中会包含SSL版本以及加密组件。服务器的加密组件是从客户端接收到的加密组件中筛选出来的。
3. 之后服务器发送Certificate报文。报文中包含公开密钥。
4. 最后服务器发送Server Hello Done报文同志客户端，最初的SSL握手协商部分结束。
5. SSL第一次握手结束之后，客户端以CLient Key Exchange报文作为回应，报文中包含通信加密中使用的一种被成为Pre-master secret 的随机密码串。该报文已用步骤3中的公开密钥进行加密。
6. 接着客户端继续发送Change Cipher Spec报文，该报文会提示服务器，再次报文之后的通信会采用Pre-master secret 密钥加密。
7. 客户端发送Finished报文。该报文包含链接至今全部报文的整体校验值，这次握手协商能否成功，要以服务器是否能够正确解密该报文作为判定标准。
8. 服务器同样发送Change Cipher Exchange报文。
9. 服务器同样发送Finished报文。
10. 服务器和客户端的Finished报文交换完毕只有，SSL链接就算建立完成。当然，通信会收到SSL的保护。从此处开始进行应用层协议的通信，即发送http请求。
11. 应用层协议通信，即发送http响应。
12. 最后由客户端断开连接。

#### https的弊端

https在使用的时候必须进行SSL通信，而使用SSL通信就必须有建立SSL通信通道和加密解密的过程，这里会消耗很多的时间，导致https的性能下降，所以https也不是盲目使用的，只有在进行很重要的内容的通信的时候才使用https。

以上就是我学习https的笔记了，这是参考了《图解HTTP》这本书的。